---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import { pb } from "../utils";
import HomeModernIcon from "./icons/HomeModernIcon.astro";
import BatteryIcon from "./icons/BatteryIcon.astro";
import BoltIcon from "./icons/BoltIcon.astro";
import CpuChipIcon from "./icons/CpuChipIcon.astro";

// Fetch from Content Collection
const servicesCollection = await getCollection("services");
const services = servicesCollection.map((s) => ({
    title: s.data.title,
    slug: s.slug,
    description: s.data.description,
    image: s.data.image,
    icon: s.data.icon,
}));

const iconMap = {
    "home-modern": HomeModernIcon,
    battery: BatteryIcon,
    bolt: BoltIcon,
    "cpu-chip": CpuChipIcon,
};
---

<section id="services" class="py-16 bg-white relative">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div
            class="text-center max-w-3xl mx-auto mb-16 transition-all duration-700 opacity-0 translate-y-10 reveal-on-scroll"
        >
            <h2
                class="text-elorange font-bold tracking-wide uppercase text-sm mb-2 font-display"
            >
                Våra Expertisområden
            </h2>
            <h3
                class="text-3xl font-extrabold text-slate-900 sm:text-4xl font-display"
            >
                Tekniska lösningar för moderna behov
            </h3>
            <p class="mt-4 text-xl text-slate-500 font-sans">
                Från installation av laddbox till totalrenovering. Vi arbetar i
                hela regionen.
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
            {
                services.map((service, index) => {
                    const Icon = iconMap[service.icon as keyof typeof iconMap];
                    return (
                        <a
                            href={pb(`/tjanster/${service.slug}`)}
                            class="group relative bg-slate-50 result-card rounded-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:bg-white hover:-translate-y-1 border border-slate-100 hover:border-elblue/20 flex flex-col cursor-pointer opacity-0 translate-y-20 reveal-on-scroll"
                            style={`transition-delay: ${index * 150}ms`}
                        >
                            {/* Image Header */}
                            <div class="h-48 overflow-hidden relative">
                                {typeof service.image === "string" ? (
                                    <img
                                        src={service.image}
                                        alt={service.title}
                                        class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                                    />
                                ) : (
                                    <Image
                                        src={service.image}
                                        alt={service.title}
                                        class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                                        width={600}
                                        height={400}
                                    />
                                )}
                                <div class="absolute inset-0 bg-gradient-to-t from-slate-900/60 to-transparent opacity-60 group-hover:opacity-40 transition-opacity" />
                            </div>

                            {/* Content */}
                            <div class="p-6 flex flex-col flex-grow">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-8 h-8 rounded-md bg-elblue/10 flex items-center justify-center text-elblue group-hover:bg-elblue group-hover:text-white transition-colors">
                                        <Icon className="w-5 h-5" />
                                    </div>
                                    <h4 class="text-xl font-bold text-slate-900 font-display">
                                        {service.title}
                                    </h4>
                                </div>

                                <p class="text-slate-600 leading-relaxed text-sm flex-grow">
                                    {service.description}
                                </p>

                                <div class="mt-6 pt-4 border-t border-slate-200">
                                    <span class="text-sm font-semibold text-elblue group-hover:text-elorange transition-colors flex items-center">
                                        Läs mer{" "}
                                        <span class="ml-2 group-hover:translate-x-1 transition-transform">
                                            →
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </a>
                    );
                })
            }
        </div>
    </div>
</section>

<script>
    const observerOptions = {
        threshold: 0.1,
        rootMargin: "0px",
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                entry.target.classList.remove(
                    "opacity-0",
                    "translate-y-10",
                    "translate-y-20",
                );
                entry.target.classList.add("opacity-100", "translate-y-0");

                // Clear the transition delay after the animation is complete so hover effects remain snappy
                setTimeout(() => {
                    (entry.target as HTMLElement).style.transitionDelay = "0s";
                }, 1000); // 1000ms is enough to cover the longest delay + duration

                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);

    document
        .querySelectorAll(".reveal-on-scroll")
        .forEach((el) => observer.observe(el));
</script>
