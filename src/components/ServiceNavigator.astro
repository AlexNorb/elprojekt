---
import { pb } from "../utils";
import BoltIcon from "./icons/BoltIcon.astro";
import BatteryIcon from "./icons/BatteryIcon.astro";
import HomeModernIcon from "./icons/HomeModernIcon.astro";
import ChatBubbleLeftRightIcon from "./icons/ChatBubbleLeftRightIcon.astro";
import PhoneIcon from "./icons/PhoneIcon.astro";
import ArrowRightIcon from "./icons/ArrowRightIcon.astro";
import ArrowLeftIcon from "./icons/ArrowLeftIcon.astro";
import StarIcon from "./icons/StarIcon.astro";

// Service Slugs based on src/data/services.ts
const SERVICES = {
    RENOVATION: "renovering-nybyggnation",
    EV_CHARGING: "laddbox-elbil",
    SERVICE: "service-underhall",
    SMART_HOME: "smarta-hem",
};
---

<service-navigator
    class="relative block rounded-2xl bg-slate-900/90 border border-white/10 backdrop-blur-xl overflow-hidden shadow-2xl ring-1 ring-white/10 md:max-w-md w-full mx-auto lg:ml-auto lg:mx-0 animate-fade-in-up"
    style="animation-delay: 0.6s;"
>
    <!-- Header -->
    <div class="p-6 border-b border-white/10 bg-white/5">
        <h3
            class="text-white font-display text-xl font-bold mb-1 flex items-center justify-between"
            id="nav-title"
        >
            <span>Vad s√∂ker du?</span>
        </h3>
        <p class="text-slate-400 text-sm" id="nav-subtitle">
            Hitta r√§tt tj√§nst f√∂r dig.
        </p>
    </div>

    <!-- Content Area -->
    <div class="relative min-h-[320px] flex flex-col">
        <!-- Step 1: Category Selection -->
        <div data-step="1" class="step-content p-2 fade-in flex-1">
            <div class="grid grid-cols-2 gap-2 h-full">
                <button
                    class="step-btn group relative flex flex-col items-center justify-center p-4 rounded-xl bg-slate-800/50 hover:bg-slate-700/80 border border-white/5 hover:border-elblue/50 transition-all duration-300"
                    data-category="renovation"
                >
                    <div
                        class="w-12 h-12 rounded-full mb-3 flex items-center justify-center text-white bg-blue-600/20 group-hover:bg-blue-600 group-hover:scale-110 transition-all duration-300"
                    >
                        <HomeModernIcon className="w-6 h-6" />
                    </div>
                    <span class="text-slate-200 text-sm font-medium text-center"
                        >Nybyggnation & Renovering</span
                    >
                </button>

                <button
                    class="step-btn group relative flex flex-col items-center justify-center p-4 rounded-xl bg-slate-800/50 hover:bg-slate-700/80 border border-white/5 hover:border-green-500/50 transition-all duration-300"
                    data-category="ev"
                >
                    <div
                        class="w-12 h-12 rounded-full mb-3 flex items-center justify-center text-white bg-green-600/20 group-hover:bg-green-600 group-hover:scale-110 transition-all duration-300"
                    >
                        <BatteryIcon className="w-6 h-6" />
                    </div>
                    <span class="text-slate-200 text-sm font-medium text-center"
                        >Laddbox & Elbil</span
                    >
                </button>

                <button
                    class="step-btn group relative flex flex-col items-center justify-center p-4 rounded-xl bg-slate-800/50 hover:bg-slate-700/80 border border-white/5 hover:border-red-500/50 transition-all duration-300"
                    data-category="service"
                >
                    <div
                        class="w-12 h-12 rounded-full mb-3 flex items-center justify-center text-white bg-red-600/20 group-hover:bg-red-600 group-hover:scale-110 transition-all duration-300"
                    >
                        <BoltIcon className="w-6 h-6" />
                    </div>
                    <span class="text-slate-200 text-sm font-medium text-center"
                        >Service & Fels√∂kning</span
                    >
                </button>

                <button
                    class="step-btn group relative flex flex-col items-center justify-center p-4 rounded-xl bg-slate-800/50 hover:bg-slate-700/80 border border-white/5 hover:border-orange-500/50 transition-all duration-300"
                    data-category="other"
                >
                    <div
                        class="w-12 h-12 rounded-full mb-3 flex items-center justify-center text-white bg-orange-600/20 group-hover:bg-orange-600 group-hover:scale-110 transition-all duration-300"
                    >
                        <StarIcon className="w-6 h-6" />
                    </div>
                    <span class="text-slate-200 text-sm font-medium text-center"
                        >Referenser & √ñvrigt</span
                    >
                </button>
            </div>
        </div>

        <!-- Step 2: Sub-selection -->
        <div data-step="2" class="step-content p-4 hidden flex-1 flex flex-col">
            <div id="step-2-options" class="grid grid-cols-1 gap-3">
                <!-- Dynamically injected buttons -->
            </div>
        </div>

        <!-- Step 3: Result / Action -->
        <div
            data-step="3"
            class="step-content p-6 hidden flex-1 flex flex-col items-center justify-center text-center"
        >
            <div
                id="result-icon"
                class="w-20 h-20 rounded-full flex items-center justify-center mb-6 transition-all duration-500"
            >
                <!-- Icon injected here -->
            </div>

            <h4
                id="result-title"
                class="text-2xl font-display font-bold text-white mb-2"
            >
            </h4>
            <p
                id="result-text"
                class="text-slate-300 text-sm mb-8 leading-relaxed max-w-xs mx-auto"
            >
            </p>

            <a
                id="result-btn"
                href="#"
                class="w-full py-4 px-6 rounded-lg font-bold text-white transition-all transform hover:-translate-y-1 shadow-lg flex items-center justify-center gap-2"
            >
                <span>G√• vidare</span>
                <ArrowRightIcon className="w-5 h-5" />
            </a>
        </div>
    </div>

    <!-- Footer / Navigation Controls -->
    <div
        class="p-4 bg-slate-950/50 border-t border-white/5 flex justify-between items-center"
        id="nav-footer"
    >
        <button
            type="button"
            class="text-slate-400 hover:text-white text-sm font-medium flex items-center gap-2 opacity-0 pointer-events-none transition-opacity"
            id="btn-back"
        >
            <ArrowLeftIcon className="w-4 h-4" />
            Tillbaka
        </button>

        <!-- Only visible on Step 1 -->
        <div
            class="text-xs text-slate-500 flex items-center gap-1"
            id="info-text"
        >
            <span>‚ö°</span> Guider dig r√§tt
        </div>
    </div>
</service-navigator>

<style>
    .fade-in {
        animation: fadeIn 0.3s ease-out forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script define:vars={{ SERVICES, BASE_URL: import.meta.env.BASE_URL }}>
    class ServiceNavigator extends HTMLElement {
        constructor() {
            super();
            this.state = {
                step: 1,
                category: null,
                selection: null,
            };

            // Client-side implementation of pb()
            this.pb = (path) => {
                const base = BASE_URL.replace(/\/$/, "");
                const cleanPath = path.startsWith("/") ? path : `/${path}`;
                if (cleanPath === "/") return base || "/";
                return `${base}${cleanPath}`;
            };

            // DOM Elements
            this.steps = {
                1: this.querySelector('[data-step="1"]'),
                2: this.querySelector('[data-step="2"]'),
                3: this.querySelector('[data-step="3"]'),
            };

            this.ui = {
                title: this.querySelector("#nav-title span"),
                subtitle: this.querySelector("#nav-subtitle"),
                backBtn: this.querySelector("#btn-back"),
                infoText: this.querySelector("#info-text"),
                step2Options: this.querySelector("#step-2-options"),

                // Result UI
                resultIcon: this.querySelector("#result-icon"),
                resultTitle: this.querySelector("#result-title"),
                resultText: this.querySelector("#result-text"),
                resultBtn: this.querySelector("#result-btn"),
            };

            this.init();
        }

        init() {
            // Step 1 Handlers
            this.querySelectorAll("[data-category]").forEach((btn) => {
                btn.addEventListener("click", () => {
                    const category = btn.getAttribute("data-category");
                    this.handleCategory(category);
                });
            });

            // Back Button
            this.ui.backBtn.addEventListener("click", () => {
                this.setStep(this.state.step - 1);
            });
        }

        handleCategory(category) {
            this.state.category = category;
            this.renderStep2(category);
            this.setStep(2);
        }

        renderStep2(category) {
            const container = this.ui.step2Options;
            container.innerHTML = ""; // Clear previous

            let options = [];

            if (category === "renovation") {
                options = [
                    {
                        label: "K√∂k & Badrum",
                        icon: "üíß",
                        action: "link",
                        slug: SERVICES.RENOVATION,
                        text: "Planering och installation f√∂r v√•trum och k√∂ksmilj√∂er.",
                    },
                    {
                        label: "Helt nytt hus",
                        icon: "üè†",
                        action: "link",
                        slug: SERVICES.RENOVATION,
                        text: "Totalentreprenad f√∂r elinstallationer i nyproduktion.",
                    },
                    {
                        label: "Utbyggnad / Garage",
                        icon: "üèóÔ∏è",
                        action: "link",
                        slug: SERVICES.RENOVATION,
                        text: "Ut√∂kning av befintlig anl√§ggning.",
                    },
                ];
            } else if (category === "ev") {
                options = [
                    {
                        label: "Offert: Box + Installation",
                        icon: "üîå",
                        action: "link",
                        slug: SERVICES.EV_CHARGING,
                        text: "Nyckelf√§rdiga paket med laddbox och installation.",
                    },
                    {
                        label: "Bostadsr√§ttsf√∂rening",
                        icon: "üè¢",
                        action: "link",
                        slug: SERVICES.EV_CHARGING,
                        text: "Skalbara laddl√∂sningar f√∂r f√∂reningar och f√∂retag.",
                    },
                    {
                        label: "Bara Installation",
                        icon: "‚ö°",
                        action: "link",
                        slug: SERVICES.EV_CHARGING,
                        text: "Installation av din befintliga laddbox.",
                    },
                ];
            } else if (category === "service") {
                options = [
                    {
                        label: "Str√∂ml√∂st / Akut",
                        icon: "üö®",
                        action: "call",
                        text: "Ring oss direkt f√∂r akut hj√§lp. Vi svarar dygnet runt.",
                    },
                    {
                        label: "Fels√∂kning / Reparation",
                        icon: "üîç",
                        action: "link",
                        slug: SERVICES.SERVICE,
                        text: "Vi hittar och √•tg√§rdar felet i din anl√§ggning.",
                    },
                    {
                        label: "Byte av Elcentral",
                        icon: "‚ö°",
                        action: "link",
                        slug: SERVICES.SERVICE,
                        text: "Modernisera din elcentral med jordfelsbrytare.",
                    },
                ];
            } else if (category === "other") {
                options = [
                    {
                        label: "Se v√•ra referenser",
                        icon: "‚≠ê",
                        action: "link",
                        url: "/referenser",
                        text: "Bilder och case fr√•n v√•ra tidigare projekt.",
                    },
                    {
                        label: "Kontakta Oss",
                        icon: "‚úâÔ∏è",
                        action: "link",
                        url: "/#contact",
                        text: "Skicka ett meddelande s√• h√∂r vi av oss.",
                    },
                ];
            }

            options.forEach((opt) => {
                const btn = document.createElement("button");
                btn.className =
                    "w-full text-left p-4 rounded-xl bg-slate-800/50 hover:bg-slate-700 border border-white/5 hover:border-elblue/50 text-slate-200 hover:text-white transition-all duration-200 flex justify-between items-center group";
                btn.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-lg">${opt.icon}</span>
                        <span class="font-medium">${opt.label}</span>
                    </div>
                    <span class="w-6 h-6 rounded-full bg-white/5 flex items-center justify-center text-slate-400 group-hover:bg-elblue group-hover:text-white transition-colors">‚Üí</span>
                `;
                btn.addEventListener("click", () => {
                    this.showResult(opt);
                });
                container.appendChild(btn);
            });
        }

        showResult(option) {
            // Update UI for Step 3
            this.state.selection = option;

            // Icon Background Color based on action
            let iconBg = "bg-elblue";
            let btnBg = "bg-elblue hover:bg-elblue-600";

            if (option.action === "call") {
                iconBg = "bg-red-600 animate-pulse";
                btnBg = "bg-red-600 hover:bg-red-500 shadow-red-500/50";
                this.ui.resultBtn.href = "tel:0701234567";
                this.ui.resultBtn.innerHTML = `<span>Ring 070-123 45 67</span> <span class="w-5 h-5">üìû</span>`;
            } else {
                // Link
                if (option.url) {
                    this.ui.resultBtn.href = this.pb(option.url);
                } else {
                    this.ui.resultBtn.href = this.pb(
                        `/services/${option.slug}`,
                    );
                }
                this.ui.resultBtn.innerHTML = `<span>G√• till sidan</span> <span class="w-5 h-5">‚Üí</span>`;
            }

            this.ui.resultIcon.className = `w-20 h-20 rounded-full flex items-center justify-center mb-6 shadow-2xl ${iconBg}`;
            this.ui.resultIcon.innerHTML = `<span class="text-4xl text-white">${option.icon}</span>`;

            this.ui.resultTitle.textContent = option.label;
            this.ui.resultText.textContent = option.text;

            this.ui.resultBtn.className = `w-full py-4 px-6 rounded-lg font-bold text-white transition-all transform hover:-translate-y-1 shadow-lg flex items-center justify-center gap-2 ${btnBg}`;

            this.setStep(3);
        }

        setStep(step) {
            // Hide all
            Object.values(this.steps).forEach((el) => {
                el.classList.add("hidden");
                el.classList.remove("fade-in");
            });

            // Show current
            const currentEl = this.steps[step];
            currentEl.classList.remove("hidden");
            currentEl.classList.add("fade-in");

            // Update State
            this.state.step = step;
            this.updateHeader(step);
        }

        updateHeader(step) {
            // Toggle Back Button
            if (step > 1) {
                this.ui.backBtn.classList.remove(
                    "opacity-0",
                    "pointer-events-none",
                );
                this.ui.infoText.classList.add("hidden");
            } else {
                this.ui.backBtn.classList.add(
                    "opacity-0",
                    "pointer-events-none",
                );
                this.ui.infoText.classList.remove("hidden");
            }

            // Update Text
            if (step === 1) {
                this.ui.title.textContent = "Vad s√∂ker du?";
                this.ui.subtitle.textContent = "Hitta r√§tt tj√§nst f√∂r dig.";
            } else if (step === 2) {
                this.ui.title.textContent = "V√§lj inriktning";
                this.ui.subtitle.textContent = "Vad passar b√§st?";
            } else if (step === 3) {
                this.ui.title.textContent = "Rekommendation";
                this.ui.subtitle.textContent = "H√§r √§r vad vi f√∂resl√•r.";
            }
        }
    }

    customElements.define("service-navigator", ServiceNavigator);
</script>
