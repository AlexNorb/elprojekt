---
import StarIcon from "./icons/StarIcon.astro";
import CheckBadgeIcon from "./icons/CheckBadgeIcon.astro";

const reviews = [
    {
        name: "Anders P.",
        location: "Stenungsund",
        text: "Installerade laddbox och drog ny el till garaget. Otroligt proffsigt bemötande från första kontakt till färdigt jobb. Kändes tryggt att ha en elektriker som var lätt att nå.",
        stars: 5,
    },
    {
        name: "Maria Lindberg",
        location: "Tjörn",
        text: "Anlitade ELPROJEKT för köksrenovering. Bra samarbete med snickarna och snygga lösningar för belysningen som jag inte tänkt på själv. Rekommenderas varmt!",
        stars: 5,
    },
    {
        name: "BRF Strandkanten",
        location: "Uddevalla",
        text: "Vi bytte ut belysningen i trapphusen till LED med rörelsevakt. Snabbt jobb och fakturan stämde exakt med offerten. En pålitlig partner.",
        stars: 5,
    },
];
---

<section class="py-12 bg-white text-slate-900 relative overflow-hidden">
    {/* Background accents */}
    <div
        class="absolute top-0 right-0 w-96 h-96 bg-elblue-100 rounded-full blur-[100px] opacity-50"
    >
    </div>
    <div
        class="absolute bottom-0 left-0 w-64 h-64 bg-elorange/10 rounded-full blur-[80px]"
    >
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 group">
        <div class="text-center mb-8">
            <h2
                class="text-elorange font-bold tracking-wide uppercase text-sm mb-1 font-display"
            >
                Kundomdömen
            </h2>
            <h3
                class="text-2xl font-extrabold sm:text-3xl font-display text-slate-900"
            >
                Lokalt förtroende
            </h3>
        </div>

        <div class="relative">
            {/* Carousel Container */}
            <div
                id="reviews-carousel"
                class="flex items-stretch overflow-x-auto snap-x snap-mandatory gap-4 pb-4 -mx-4 px-4 md:grid md:grid-cols-3 md:gap-6 md:pb-0 md:mx-0 md:px-0 scrollbar-hide scroll-smooth"
            >
                {
                    reviews.map((review, index) => (
                        <div
                            class="review-card min-w-[85%] sm:min-w-[350px] md:min-w-0 snap-center transition-all duration-300 transform scale-95 opacity-70 md:scale-100 md:opacity-100 flex flex-col"
                            data-index={index}
                        >
                            <div class="bg-slate-50 p-6 rounded-lg border border-slate-100 hover:border-elblue/30 shadow-sm flex flex-col justify-between flex-1 h-full">
                                <div>
                                    <div class="flex space-x-1 text-elorange mb-3">
                                        {Array.from({
                                            length: review.stars,
                                        }).map((_) => (
                                            <StarIcon className="w-4 h-4" />
                                        ))}
                                    </div>
                                    <p class="text-slate-600 italic mb-4 leading-relaxed text-sm">
                                        "{review.text}"
                                    </p>
                                </div>
                                <div class="flex items-center justify-between border-t border-slate-200 pt-3 mt-auto">
                                    <div>
                                        <div class="font-bold text-slate-900 font-display text-sm">
                                            {review.name}
                                        </div>
                                        <div class="text-xs text-slate-500">
                                            {review.location}
                                        </div>
                                    </div>
                                    <div class="flex items-center text-elblue text-[10px] font-medium bg-elblue-50 px-2 py-1 rounded-md border border-elblue-100">
                                        <CheckBadgeIcon className="w-3 h-3 mr-1" />
                                        Verifierad
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))
                }
            </div>

            {/* Pagination Dots (Mobile Only) */}
            <div class="flex justify-center gap-2 mt-2 md:hidden">
                {
                    reviews.map((_, index) => (
                        <button
                            class="carousel-dot w-2.5 h-2.5 rounded-full bg-slate-300 transition-all duration-300 hover:bg-elorange/50 focus:outline-none"
                            aria-label={`Gå till omdöme ${index + 1}`}
                            data-index={index}
                        />
                    ))
                }
            </div>
        </div>
    </div>

    <style>
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .carousel-dot.active {
            background-color: var(--color-elorange);
            transform: scale(1.2);
        }
    </style>

    <script>
        const carousel = document.getElementById("reviews-carousel");
        const cards = document.querySelectorAll(".review-card");
        const dots = document.querySelectorAll(".carousel-dot");

        // Click Handler for Dots
        dots.forEach((dot) => {
            dot.addEventListener("click", () => {
                const index = parseInt(dot.getAttribute("data-index") || "0");
                const card = cards[index];
                if (card && carousel && card instanceof HTMLElement) {
                    // Mobile horizontal spacing is -mx-4 (1rem) + px-4.
                    // To center the card, we want its left to be at carousel left + padding.
                    // Simple offsetLeft works well with snap scrolling usually.
                    const left = card.offsetLeft - (carousel.offsetLeft || 0);
                    // Adjust for the container padding if needed.
                    // Actually, simpler is scrollIntoView but that scrolls whole page sometimes.
                    carousel.scrollTo({ left: left, behavior: "smooth" });
                }
            });
        });

        // Intersection Observer for Scale Effect and Dots
        const observerOptions = {
            root: carousel,
            threshold: 0.5, // Trigger when 50% visible
        };

        const observer = new IntersectionObserver((entries) => {
            // Only apply on mobile where we have the horizontal scroll
            if (window.innerWidth >= 768) return;

            entries.forEach((entry) => {
                const card = entry.target;
                const index = card.getAttribute("data-index");

                if (entry.isIntersecting) {
                    // Card Visuals
                    card.classList.remove("scale-95", "opacity-70");
                    card.classList.add("scale-100", "opacity-100");

                    // Dot Visuals
                    if (index !== null) {
                        dots.forEach((d) => d.classList.remove("active"));
                        const activeDot = document.querySelector(
                            `.carousel-dot[data-index="${index}"]`,
                        );
                        if (activeDot) activeDot.classList.add("active");
                    }
                } else {
                    card.classList.add("scale-95", "opacity-70");
                    card.classList.remove("scale-100", "opacity-100");
                }
            });
        }, observerOptions);

        cards.forEach((card) => observer.observe(card));

        // Initial check/set active state
        if (cards.length > 0 && window.innerWidth < 768) {
            cards[0].classList.remove("scale-95", "opacity-70");
            cards[0].classList.add("scale-100", "opacity-100");
            if (dots.length > 0) dots[0].classList.add("active");
        }
    </script>
</section>
